name: 칸반 - 백로그에 추가
description: 새로 열린 이슈를 조직 Projects(v2) 보드에 추가하고 상태/라벨을 동기화합니다
inputs:
  org:
    description: 조직 로그인(organization 로그인)
    required: true
  project-number:
    description: Projects(v2) 보드 번호(선택)
    required: false
  project-name:
    description: Projects(v2) 보드 제목(번호가 없거나 다를 때 사용)
    required: false
  backlog:
    description: 백로그 컬럼 이름
    required: true
  planned:
    description: 작업 예정 컬럼 이름
    required: true
  in-progress:
    description: 작업중 컬럼 이름
    required: true
  review:
    description: 리뷰 대기 컬럼 이름
    required: true
  done:
    description: 완료 컬럼 이름
    required: true
  github-token:
    description: 조직 클래식 프로젝트 API 접근 토큰(PAT 권장). 미설정 시 GITHUB_TOKEN 사용
    required: false
    default: ${{ github.token }}
runs:
  using: composite
  steps:
    - name: 백로그 컬럼에 카드 추가 및 라벨 적용
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const ORG = process.env.ORG || context.repo.owner;
          core.info(`해결된 ORG: '${ORG}'`);
          const PROJECT_NUMBER = process.env.PROJECT_NUMBER ? parseInt(process.env.PROJECT_NUMBER, 10) : undefined;
          const PROJECT_NAME = process.env.PROJECT_NAME || undefined;
          const STATUS_MAP = {
            backlog: process.env.BACKLOG,
            planned: process.env.PLANNED,
            inProgress: process.env.IN_PROGRESS,
            review: process.env.REVIEW,
            done: process.env.DONE,
          };

          if (!(context.eventName === 'issues' && context.payload.action === 'opened')) {
            core.info('이슈 생성 이벤트가 아님: 건너뜀');
            return;
          }

          const gql = String.raw;
          async function getProjectV2(org, number, name) {
            // 1) 번호로 시도 (실패해도 계속)
            if (number) {
              try {
                const q = gql`query($org:String!,$num:Int!){ organization(login:$org){ projectV2(number:$num){ id title number fields(first:50){ nodes { __typename ... on ProjectV2FieldCommon { id name dataType } ... on ProjectV2SingleSelectField { id name options { id name } } } } } } }`;
                const r = await github.graphql(q, { org, num: number });
                const p = r?.organization?.projectV2;
                if (p) return p;
              } catch (e) {
                core.warning(`projectV2 번호(${number}) 조회 실패: ${e.message}`);
              }
            }
            // 2) 이름으로 전체 목록 조회 후 매칭
            try {
              const q = gql`query($org:String!){ organization(login:$org){ projectsV2(first:100){ nodes { id title number fields(first:50){ nodes { __typename ... on ProjectV2FieldCommon { id name dataType } ... on ProjectV2SingleSelectField { id name options { id name } } } } } } } }`;
              const r = await github.graphql(q, { org });
              const list = r?.organization?.projectsV2?.nodes || [];
              core.info(`v2 프로젝트 목록: ${list.map(n => `${n.number}:${n.title}`).join(', ')}`);
              if (name) {
                const p = list.find(n => n.title === name);
                if (p) return p;
              }
              // 3) 번호가 있었고 목록에 있으면 그 번호로도 재확인
              if (number) {
                const p = list.find(n => n.number === number);
                if (p) return p;
              }
            } catch (e) {
              core.warning(`projectsV2 목록 조회 실패: ${e.message}`);
            }
            return null;
          }

          async function getIssueId(owner, repo, number) {
            const q = gql`query($owner:String!,$repo:String!,$num:Int!){ repository(owner:$owner,name:$repo){ issue(number:$num){ id } } }`;
            const r = await github.graphql(q, { owner, repo, num: number });
            return r?.repository?.issue?.id || null;
          }

          async function ensureItem(projectId, issueId) {
            const q = gql`query($id:ID!){ node(id:$id){ ... on Issue { projectItems(first:50){ nodes { id project{ id title number } } } } } }`;
            const r = await github.graphql(q, { id: issueId });
            const existing = r?.node?.projectItems?.nodes?.find(n => n.project?.id === projectId);
            if (existing) return existing.id;
            const m = gql`mutation($projectId:ID!,$contentId:ID!){ addProjectV2ItemById(input:{projectId:$projectId, contentId:$contentId}){ item { id } } }`;
            const res = await github.graphql(m, { projectId, contentId: issueId });
            return res?.addProjectV2ItemById?.item?.id;
          }

          function findStatusField(project) {
            const fields = project?.fields?.nodes || [];
            let field = fields.find(f => f.name === 'Status') || fields.find(f => f.name === '상태');
            if (!field) field = fields.find(f => (f.__typename === 'ProjectV2SingleSelectField'));
            return field;
          }

          async function setStatus(project, itemId, statusName) {
            const field = findStatusField(project);
            if (!field || !field.options) { core.warning('Status 필드를 찾지 못했거나 옵션이 없습니다.'); return; }
            const opt = field.options.find(o => o.name === statusName);
            if (!opt) { core.warning(`Status 옵션을 찾지 못했습니다: ${statusName}. 사용 가능: ${field.options.map(o=>o.name).join(', ')}`); return; }
            const m = gql`mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $optionId:String!){ updateProjectV2ItemFieldValue(input:{ projectId:$projectId, itemId:$itemId, fieldId:$fieldId, value:{ singleSelectOptionId:$optionId }}){ projectV2Item { id } } }`;
            await github.graphql(m, { projectId: project.id, itemId, fieldId: field.id, optionId: opt.id });
          }

          const { owner, repo } = context.repo;
          const issue_number = context.payload.issue.number;
          const project = await getProjectV2(ORG, PROJECT_NUMBER, PROJECT_NAME);
          if (!project) { core.warning('Projects(v2) 프로젝트를 찾지 못해 건너뜁니다.'); return; }
          const issueId = await getIssueId(owner, repo, issue_number);
          if (!issueId) { core.warning('이슈 ID를 찾지 못했습니다.'); return; }
          const itemId = await ensureItem(project.id, issueId);
          if (!itemId) { core.warning('프로젝트 아이템을 생성/확인하지 못했습니다.'); return; }

          // 라벨 동기화는 REST로 유지
          async function setIssueStatusLabel(owner, repo, issue_number, label) {
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const allStatus = Object.values(STATUS_MAP);
            const existing = issue.labels.map(l => typeof l === 'string' ? l : l.name);
            const filtered = existing.filter(n => !allStatus.includes(n));
            const finalLabels = [...new Set([...filtered, label])];
            await github.rest.issues.update({ owner, repo, issue_number, labels: finalLabels });
          }

          await setStatus(project, itemId, STATUS_MAP.backlog);
          await setIssueStatusLabel(owner, repo, issue_number, STATUS_MAP.backlog);
      env:
        ORG: ${{ inputs.org }}
        PROJECT_NUMBER: ${{ inputs['project-number'] }}
        PROJECT_NAME: ${{ inputs['project-name'] }}
        BACKLOG: ${{ inputs.backlog }}
        PLANNED: ${{ inputs.planned }}
        IN_PROGRESS: ${{ inputs['in-progress'] }}
        REVIEW: ${{ inputs.review }}
        DONE: ${{ inputs.done }}
